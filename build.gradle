buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath "net.sf.proguard:proguard-gradle:6.0.1"
    }
}

plugins {
    id 'com.github.johnrengelman.shadow' version '2.0.3'
    id "org.jetbrains.kotlin.jvm" version "1.2.31"
    id 'idea'
}

println """
*******************************************
 You are building Voodoo Toolset ! 

 Output files will be in [subproject]/build/libs
*******************************************
"""

//group = 'moe.nikky'

idea {
    module {
        excludeDirs += [file("run")]
    }
}

subprojects {
    apply plugin: "kotlin"
    group = group
    version = version

    sourceCompatibility = 1.8
    targetCompatibility = 1.8

    compileKotlin {
        kotlinOptions {
            languageVersion = "1.2"
        }
    }

    repositories {
        mavenCentral()
        jcenter()
        maven { url "http://repo.maven.apache.org/maven2" }
        maven { url "https://jitpack.io" }
        maven { url "http://jcenter.bintray.com" }
    }

    idea {
        module {
            excludeDirs += [file("run")]
        }
    }

    sourceSets {
        main.kotlin.srcDirs += "$buildDir/generated-src"
    }
//    version = "${project.major}.${project.minor}.${project.patch}"
    compileKotlin.doFirst {
        def folder = project.name != "voodoo" ? "voodoo/${project.name}" : "voodoo"
        copy {
            from "../template/kotlin/voodoo/"
            into  "$buildDir/generated-src/$folder"
            expand(
                    PACKAGE: folder.replace('/', '.').replace('-', '.'),
                    MAJOR_VERSION: project.major,
                    MINOR_VERSION: project.minor,
                    PATCH_VERSION: project.patch,
                    BUILD_NUMBER: System.env.BUILD_NUMBER ?: -1
            )
        }
    }
    if (System.env.BUILD_NUMBER) {
        version = System.env.BUILD_NUMBER
    }
}
